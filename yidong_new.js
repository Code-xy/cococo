/**
 * ç§»åŠ¨è´¦å•æ‹¦æˆªè„šæœ¬
 * åŠŸèƒ½ï¼šæ‹¦æˆªç§»åŠ¨APIå“åº”ï¼Œæ›¿æ¢ä¸ºåç«¯åŠ å¯†åçš„å“åº”
 * ä½¿ç”¨ï¼šscript-response-body
 * 
 * ç‰¹ç‚¹ï¼šåç«¯è‡ªåŠ¨è¿›è¡ŒAESåŠ å¯†ï¼Œæ— éœ€è„šæœ¬å¤„ç†åŠ å¯†é€»è¾‘
 */

const SERVER_URL = 'http://192.168.240.68:8006';

// ============================================================
// æ—¥å¿—å‡½æ•°
// ============================================================
function log(message) {
    console.log(`[ç§»åŠ¨æ›¿æ¢] ${message}`);
}

// ============================================================
// ä¸»é€»è¾‘
// ============================================================
(async function main() {
    try {
        log("============================================================");
        log("ğŸ”” æ‹¦æˆªåˆ°ç§»åŠ¨å“åº”ï¼Œå‡†å¤‡æ›¿æ¢");
        log("============================================================");

        // è¯·æ±‚åç«¯è·å–åŠ å¯†åçš„å“åº”
        log(`ğŸ“¡ è¯·æ±‚åç«¯: ${SERVER_URL}/api/yidong/proxy`);

        const response = await new Promise((resolve, reject) => {
            $task.fetch({
                url: `${SERVER_URL}/api/yidong/proxy`,
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                resolve(response);
            }).catch(error => {
                reject(error);
            });
        });

        log(`âœ… åç«¯å“åº”çŠ¶æ€: ${response.statusCode}`);

        if (response.statusCode === 200) {
            log(`ğŸ“¦ åŠ å¯†å“åº”é•¿åº¦: ${response.body.length} å­—ç¬¦`);
            log(`ğŸ” å“åº”å·²ç”±åç«¯AESåŠ å¯†`);
            log(`ğŸ‰ æˆåŠŸï¼è¿”å›åŠ å¯†åçš„ç§»åŠ¨è´¦å•æ•°æ®`);
            log("============================================================");
            
            // ç›´æ¥è¿”å›åç«¯çš„åŠ å¯†å“åº”
            $done({ body: response.body });
            return;
        } else {
            log(`âš ï¸ åç«¯è¿”å›çŠ¶æ€ç : ${response.statusCode}`);
        }

        // å¦‚æœåç«¯å¤±è´¥ï¼Œè¿”å›åŸå§‹å“åº”
        log("ğŸ’¡ åç«¯å¤±è´¥ï¼Œè¿”å›åŸå§‹å“åº”");
        log("============================================================");
        $done({});

    } catch (error) {
        log(`âŒ è„šæœ¬æ‰§è¡Œå‡ºé”™: ${error.message || error}`);
        log("============================================================");
        $done({});
    }
})();

