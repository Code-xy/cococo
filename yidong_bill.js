/**
 * ç§»åŠ¨è´¦å•æ‹¦æˆªè„šæœ¬
 * åŠŸèƒ½ï¼šæ‹¦æˆªè´¦å•APIï¼Œä½¿ç”¨å­˜å‚¨çš„æ‰‹æœºå·è·å–ä¿®æ”¹åçš„å“åº”
 * ä½¿ç”¨ï¼šscript-response-body
 * 
 * ç‰¹ç‚¹ï¼š
 * 1. ä»$prefsè¯»å–æ‰‹æœºå·
 * 2. è¯·æ±‚åç«¯è·å–ä¿®æ”¹åçš„è´¦å•å“åº”
 * 3. åç«¯è‡ªåŠ¨è¿›è¡ŒAESåŠ å¯†ï¼Œæ— éœ€è„šæœ¬å¤„ç†åŠ å¯†é€»è¾‘
 * 4. å°†åŠ å¯†å­—ç¬¦ä¸²åŒ…è£¹åœ¨ { body: "åŠ å¯†å­—ç¬¦ä¸²" } æ ¼å¼ä¸­
 */

const SERVER_URL = 'http://155.94.157.70:8005';
const PHONE_STORAGE_KEY = 'yidong_phone'; // å­˜å‚¨æ‰‹æœºå·çš„key

// ============================================================
// æ—¥å¿—å‡½æ•°
// ============================================================
function log(message) {
    console.log(`[ç§»åŠ¨è´¦å•] ${message}`);
}

// ============================================================
// ä¸»é€»è¾‘
// ============================================================
(async function main() {
    try {
        log("============================================================");
        log("ğŸ”” æ‹¦æˆªåˆ°ç§»åŠ¨è´¦å•å“åº”ï¼Œå‡†å¤‡æ›¿æ¢");
        log("============================================================");

        // ä»$prefsè¯»å–æ‰‹æœºå·
        let phone = $prefs.valueForKey(PHONE_STORAGE_KEY);
        
        if (phone) {
            log(`âœ… è¯»å–åˆ°å­˜å‚¨çš„æ‰‹æœºå·: ${phone}`);
        } else {
            log(`âš ï¸ æœªæ‰¾åˆ°å­˜å‚¨çš„æ‰‹æœºå·ï¼Œå°†ä½¿ç”¨åç«¯é»˜è®¤åŒ¹é…ç­–ç•¥`);
            log(`ğŸ’¡ è¯·ç¡®ä¿å…ˆè®¿é—®ç”¨æˆ·ä¿¡æ¯APIä»¥æå–æ‰‹æœºå·`);
        }

        // æ„å»ºåç«¯è¯·æ±‚URL
        let backendUrl = `${SERVER_URL}/api/yidong/proxy`;
        if (phone) {
            backendUrl += `?phone=${encodeURIComponent(phone)}`;
            log(`ğŸ“¡ è¯·æ±‚åç«¯ï¼ˆå¸¦æ‰‹æœºå·ï¼‰: ${backendUrl}`);
        } else {
            log(`ğŸ“¡ è¯·æ±‚åç«¯ï¼ˆæ— æ‰‹æœºå·ï¼‰: ${backendUrl}`);
            log(`ğŸ’¡ åç«¯å°†ä½¿ç”¨é»˜è®¤è´¦æˆ·åŒ¹é…ç­–ç•¥`);
        }

        // è¯·æ±‚åç«¯è·å–åŠ å¯†åçš„å“åº”
        const response = await new Promise((resolve, reject) => {
            $task.fetch({
                url: backendUrl,
                method: 'GET',
                headers: {
                    'Content-Type': 'application/json'
                }
            }).then(response => {
                resolve(response);
            }).catch(error => {
                reject(error);
            });
        });

        log(`âœ… åç«¯å“åº”çŠ¶æ€: ${response.statusCode}`);

        if (response.statusCode === 200) {
            const encryptedData = response.body; // åç«¯è¿”å›çš„åŠ å¯†å­—ç¬¦ä¸²
            log(`ğŸ“¦ åŠ å¯†æ•°æ®é•¿åº¦: ${encryptedData ? encryptedData.length : 0} å­—ç¬¦`);
            log(`ğŸ“¦ åŠ å¯†æ•°æ®å‰50å­—ç¬¦: ${encryptedData ? encryptedData.substring(0, 50) : ''}`);
            
            // å…³é”®ï¼šç§»åŠ¨APIè¿”å›æ ¼å¼æ˜¯ { body: "åŠ å¯†å­—ç¬¦ä¸²" }ï¼Œä¸æ˜¯ç›´æ¥çš„åŠ å¯†å­—ç¬¦ä¸²
            const responseBody = JSON.stringify({ body: encryptedData });
            log(`ğŸ“¦ åŒ…è£…åçš„å“åº”ä½“é•¿åº¦: ${responseBody.length} å­—ç¬¦`);
            log(`ğŸ” å“åº”å·²ç”±åç«¯AESåŠ å¯†`);
            log(`ğŸ‰ æˆåŠŸï¼è¿”å›åŒ…è£…åçš„ç§»åŠ¨è´¦å•æ•°æ®`);
            log("============================================================");
            
            // è¿”å›åŒ…è£…åçš„å“åº”æ ¼å¼
            $done({ body: responseBody });
            return;
        } else {
            log(`âš ï¸ åç«¯è¿”å›çŠ¶æ€ç : ${response.statusCode}`);
            log(`âš ï¸ é”™è¯¯å“åº”å†…å®¹: ${response.body}`);
        }

        // å¦‚æœåç«¯å¤±è´¥ï¼Œè¿”å›åŸå§‹å“åº”
        log("ğŸ’¡ åç«¯å¤±è´¥ï¼Œè¿”å›åŸå§‹å“åº”");
        log("============================================================");
        $done({});

    } catch (error) {
        log(`âŒ è„šæœ¬æ‰§è¡Œå‡ºé”™: ${error.message || error}`);
        log("============================================================");
        $done({});
    }
})();
